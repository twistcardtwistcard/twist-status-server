<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TWIST Card Payment</title>
<style>
  :root { --brand:#f97316; --bg:#f3f4f6; --muted:#6b7280; --ok:#16a34a; --bad:#dc2626; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); padding: 1.5rem; }
  .form-wrapper { max-width: 540px; margin: auto; }
  .form-container { background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); position: relative; }
  .form-group { margin-bottom: 1rem; }
  label { font-weight: 600; display: block; margin-bottom: 0.35rem; }
  input { width: 100%; padding: .65rem .7rem; font-size: 1rem; border-radius: 8px; border: 1px solid #cfcfcf; outline: none; }
  input:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(249,115,22,.15); }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
  .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: .75rem; }
  button { background: var(--brand); color: #fff; border: 0; padding: .8rem 1.1rem; border-radius: 8px; cursor: pointer; font-weight: 700; }
  button[disabled] { opacity: .6; cursor: not-allowed; }
  .muted { color: var(--muted); font-size: .92rem; }
  .notice { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: .9rem; border-radius: 8px; margin-bottom: 1rem; }
  .hidden { display: none; }
  .spinner { width: 40px; height: 40px; border: 4px solid #ccc; border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin: 1rem auto; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .ok { color: var(--ok); font-weight: 700; }
  .bad { color: var(--bad); font-weight: 700; }
  .btn-inline { display:flex; gap:.5rem; }
  .err { color: var(--bad); margin-top:.4rem; font-size:.9rem; }
</style>
  <!-- ==== VISUAL THEME OVERLAY (non-breaking, CSS-only) ==== -->
<style>
  /* Tokens */
  :root{
    --brand-600:#ea580c;
    --brand-700:#c2410c;
    --ring:rgba(249,115,22,.28);
    --surface:#fff;
    --card:#fff;
    --border:#e5e7eb;
    --text:#111827;
    --muted-text:#6b7280;
    --btn-gray:#6b7280;
    --btn-gray-700:#4b5563;
  }

  /* Page & wrapper */
  body{
    background:radial-gradient(1200px 800px at 10% -10%, #fff7ed 0%, var(--bg) 42%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-rendering:optimizeLegibility;
  }
  .form-wrapper{ padding-top:.25rem; }
  .form-wrapper h2{
    font-weight:800; letter-spacing:-.02em; margin-bottom:.35rem;
  }
  #orderDetails{
    background:linear-gradient(180deg,#fff,#f8fafc);
    border:1px solid var(--border);
    padding:.75rem .9rem; border-radius:12px;
    box-shadow:0 4px 16px rgba(0,0,0,.04);
  }

  /* Container & watermark logo */
  .form-container{
    position:relative;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:1.25rem;
    box-shadow:0 10px 30px rgba(17,24,39,.08);
    overflow:hidden; /* ensures watermark respects rounded corners */
  }
  .form-container::after{
    content:"";
    position:absolute; right:10px; bottom:10px;
    width:84px; height:84px; opacity:.08; pointer-events:none;
    background-image:url("https://cdn.shopify.com/s/files/1/0745/9635/2225/files/Twist_500ppx.jpg?v=1748980607");
    background-repeat:no-repeat; background-size:contain; filter:grayscale(100%);
  }

  /* Fieldset (order summary) */
  form fieldset{
    background:linear-gradient(180deg,#f2f6fb,#eef3f7);
    border:1px solid #e2e8f0 !important; border-radius:12px !important;
  }

  /* Layout safety: never overlap */
  .row{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:.9rem; }
  .row3{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:.9rem; }
  .form-group{ min-width:0; }
  input, button{ min-width:0; box-sizing:border-box; }
  .btn-inline{ display:flex; gap:.5rem; align-items:stretch; }
  .btn-inline input{ flex:1 1 auto; min-width:0; }
  .btn-inline button{ flex:0 0 auto; }

  /* Inputs (Stripe-like) */
  label{ font-size:.925rem; color:#374151; }
  input{
    background:#fff;
    border:1px solid #d1d5db;
    border-radius:10px;
    transition:border-color .15s ease, box-shadow .15s ease, transform .06s ease;
    font-size:16px; /* avoids iOS zoom on focus */
    line-height:1.25rem;
  }
  input:hover{ border-color:#cbd5e1; }
  input:focus{
    border-color:var(--brand);
    box-shadow:0 0 0 4px var(--ring);
    transform:translateY(-1px);
  }
  input::placeholder{ color:#9ca3af; }

  /* Buttons */
  button{
    background:linear-gradient(180deg,var(--brand),var(--brand-600));
    color:#fff; border:none; border-radius:10px;
    box-shadow:0 6px 18px rgba(249,115,22,.22);
    transition:transform .08s ease, box-shadow .12s ease, filter .12s ease;
    font-size:15px; font-weight:800;
  }
  button:hover{ transform:translateY(-1px); filter:brightness(1.02); }
  button:active{ transform:translateY(0); box-shadow:0 3px 12px rgba(249,115,22,.18); }
  button[disabled]{ box-shadow:none; filter:grayscale(.12) brightness(.95); }

  /* OTP buttons should be gray (both Send OTP & Verify OTP live inside .btn-inline) */
  .btn-inline button{
    background:linear-gradient(180deg,var(--btn-gray),var(--btn-gray-700)) !important;
    box-shadow:0 4px 14px rgba(75,85,99,.22);
  }

  /* Primary submit: uppercase */
  #submitBtn{
    text-transform:uppercase; letter-spacing:.04em;
  }

  /* Notice & errors */
  .notice{
    border-color:#fde68a; background:#fffbeb; color:#854d0e;
    box-shadow:0 4px 14px rgba(245,158,11,.12);
  }
  .err{
    background:#fff1f2; border:1px solid #fecdd3; color:#be123c;
    padding:.6rem .75rem; border-radius:8px;
  }

  /* Spinner + results tone */
  .spinner{ width:44px; height:44px; border-width:4px; }
  #confirmationSuccess .ok{ color:#059669; }
  #confirmationDenied .bad{ color:#dc2626; }

  /* Mobile-first responsiveness */
  @media (max-width: 640px){
    .row, .row3{ grid-template-columns:1fr; }
    .form-container{ padding:1rem; }
    .btn-inline{ gap:.5rem; }
  }
  /* For extra-narrow phones, allow wrapping instead of overflow */
  @media (max-width: 380px){
    .btn-inline{ flex-wrap:wrap; }
    .btn-inline button{ width:100%; }
  }

  /* Dark mode (auto) */
  @media (prefers-color-scheme: dark){
    :root{
      --card:#0f172a; --border:#1f2937; --text:#e5e7eb; --muted-text:#94a3b8;
      --ring:rgba(249,115,22,.35);
    }
    body{ background:radial-gradient(1200px 800px at 10% -10%, #1f2937 0%, #0b0f17 60%); color:var(--text); }
    .form-container{ background:var(--card); border-color:var(--border); }
    form fieldset{ background:linear-gradient(180deg,#0b1220,#0b1422); border-color:#1e293b !important; }
    input{ background:#0b1220; border-color:#334155; color:var(--text); }
    input::placeholder{ color:#64748b; }
    label{ color:#cbd5e1; }
    #orderDetails{ background:linear-gradient(180deg,#0f172a,#0b1220); border-color:var(--border); }
    .notice{ background:#1a1f2a; border-color:#334155; color:#eab308; }
    .err{ background:#27151a; border-color:#7f1d1d; color:#fecaca; }
    .btn-inline button{ box-shadow:0 4px 14px rgba(0,0,0,.35); }
  }

  /* Motion safety */
  @media (prefers-reduced-motion: reduce){
    *{ transition:none !important; animation:none !important; }
  }
</style>
</head>
<body>
<div class="form-wrapper">
  <h2>Pay for your order with your TWIST CARD</h2>
  <p id="orderDetails" class="muted"></p>

  <div class="form-container" role="region" aria-label="Twist Card payment form">
    <div style="text-align:center; margin-bottom:1rem;">
      <img style="max-width:160px" alt="Twist Card"
           src="https://cdn.shopify.com/s/files/1/0745/9635/2225/files/Twist_500ppx.jpg?v=1748980607">
    </div>

    <div class="notice hidden" id="autoFillNotice">
      <strong>These fields should be auto filled.</strong><br>
      To pay with your card, click on the link provided in your order confirmation.
    </div>

    <form id="paymentForm" autocomplete="off" novalidate>
      <fieldset style="background:#eef3f7; padding:1rem; border:none; border-radius:10px; margin-bottom:1rem;">
        <div class="form-group">
          <label for="orderno">Order Number</label>
          <input type="text" id="orderno" readonly aria-readonly="true">
        </div>
        <div class="form-group">
          <label for="amount">Amount</label>
          <input type="text" id="amount" readonly aria-readonly="true">
        </div>
      </fieldset>

      <div class="form-group">
        <label for="cardNumber">Card Number</label>
        <input type="text" id="cardNumber" maxlength="17" inputmode="numeric" required placeholder="(14 digits)">
      </div>

      <div class="row">
        <div class="form-group">
          <label for="expiration">Expiration (MMYY)</label>
          <input type="text" id="expiration" placeholder="MMYY" inputmode="numeric" required>
        </div>
        <div class="form-group">
          <label for="twist">TWIST Code (XXXX)</label>
          <input type="text" id="twist" maxlength="4" inputmode="numeric" required>
        </div>
      </div>

      <div class="form-group">
        <label for="address">Address</label>
        <input type="text" id="address" autocomplete="address-line1">
      </div>

      <div class="row3">
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" autocomplete="address-level2">
        </div>
        <div class="form-group">
          <label for="province">Province (2-letter)</label>
          <input type="text" id="province" placeholder="QC" maxlength="2" autocomplete="address-level1" required>
        </div>
        <div class="form-group">
          <label for="postal">Postal Code</label>
          <input type="text" id="postal" autocomplete="postal-code" required>
        </div>
      </div>

      <div class="form-group">
        <label for="name">Cardholder Name</label>
        <input type="text" id="name" required autocomplete="cc-name">
      </div>

      <div class="form-group">
        <label for="email">Email (must match your account)</label>
        <input type="email" id="email" required autocomplete="email">
      </div>

      <div class="form-group">
        <label for="otpPhone">Phone (+1XXXXXXXXXX)</label>
        <div class="btn-inline">
          <input type="text" id="otpPhone" required autocomplete="tel" placeholder="+1##########">
          <button type="button" id="sendOtpBtn">Send OTP</button>
        </div>
        <div id="sendOtpNote" class="muted"></div>
      </div>

      <div class="form-group">
        <label for="otpCode">Enter OTP</label>
        <div class="btn-inline">
          <input type="text" id="otpCode" required inputmode="numeric" placeholder="6-digit code">
          <button type="button" id="verifyOtpBtn">Verify OTP</button>
        </div>
        <div id="otpStatus" class="muted" style="margin-top:.5rem; font-weight:700;"></div>
      </div>

      <button type="submit" id="submitBtn" disabled>Submit Payment</button>
      <div id="loadingSpinner" class="hidden" style="text-align:center; margin-top: 1rem;">
        <div class="spinner" aria-hidden="true"></div>
        <p>Processing your payment...</p>
      </div>

      <div id="clientErr" class="err hidden"></div>
    </form>

    <div id="confirmationStep" class="hidden" style="text-align:center;">
      <h3>STEP 2 — We are validating your information.</h3>
      <div class="spinner" aria-hidden="true"></div>
      <p>Please wait a moment for confirmation.</p>
    </div>

    <div id="confirmationSuccess" class="hidden" style="text-align:center;">
      <h2 class="ok">✅ Transaction Approved</h2>
      <p>Thank you! Your payment was successfully processed.</p>
    </div>

    <div id="confirmationDenied" class="hidden" style="text-align:center;">
      <h2 class="bad">❌ Transaction Denied</h2>
      <p>Please contact Twist Card customer service.</p>
    </div>
  </div>
</div>

<script>
  /* ------------ URL params ------------ */
  const qp = new URLSearchParams(window.location.search);
  const amountQP = qp.get('amount') || '';
  const ordernoQP = qp.get('orderno') || '';
  const emailQP  = qp.get('email') || '';
  document.getElementById('amount').value = amountQP;
  document.getElementById('orderno').value = ordernoQP;
  if (emailQP) document.getElementById('email').value = emailQP;
  if (!ordernoQP || !amountQP) document.getElementById('autoFillNotice').classList.remove('hidden');
  document.getElementById('orderDetails').innerHTML =
    `Order Number: <strong>${ordernoQP || '-'}</strong><br>Total: <strong>$${amountQP || '-'}</strong>`;

  /* ------------ Helpers ------------ */
  function normalizePhoneToE164_CA(input) {
    const digits = String(input || '').replace(/\D/g, '');
    const last10 = digits.slice(-10);
    return last10.length === 10 ? `+1${last10}` : null;
  }

  /* ------------ Masks / inputs ------------ */
  const cardEl = document.getElementById('cardNumber');
  const expEl = document.getElementById('expiration');
  const twistEl = document.getElementById('twist');
  const provEl = document.getElementById('province');
  const phoneEl = document.getElementById('otpPhone');
  const otpEl = document.getElementById('otpCode');
  const clientErr = document.getElementById('clientErr');

  cardEl.addEventListener('input', function () {
    let v = this.value.replace(/\D/g, '');
    if (v.length > 14) v = v.slice(0, 14);
    this.value = v.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
  });

  expEl.addEventListener('input', function () {
    let v = this.value.replace(/\D/g, '');
    this.value = v.slice(0, 4);
  });

  twistEl.addEventListener('input', function () {
    this.value = this.value.replace(/\D/g, '').slice(0, 4);
  });
  phoneEl.addEventListener('input', () => {
    const norm = normalizePhoneToE164_CA(phoneEl.value);
    phoneEl.value = norm || '+1';
  });
  otpEl.addEventListener('input', () => {
    otpEl.value = otpEl.value.replace(/\D/g, '').slice(0, 6);
  });
  provEl.addEventListener('input', () => {
    provEl.value = provEl.value.toUpperCase().slice(0,2);
  });

  /* ------------ OTP (lock the phone) ------------ */
  const OTP_PHONE_KEY = 'twistpay:lastOtpPhone';
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const otpStatus = document.getElementById('otpStatus');
  const sendOtpNote = document.getElementById('sendOtpNote');
  const submitBtn = document.getElementById('submitBtn');

  sendOtpBtn.onclick = async () => {
    const normPhone = normalizePhoneToE164_CA(phoneEl.value);
    if (!normPhone) return alert("Enter a valid Canadian number (e.g., +14165551234).");
    localStorage.setItem(OTP_PHONE_KEY, normPhone);
    sendOtpBtn.disabled = true;
    sendOtpNote.textContent = "Sending...";
    try {
      const res = await fetch('https://twilio-otp-server.onrender.com/send-otp', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ phone: normPhone })
      });
      const data = await res.json();
      sendOtpNote.textContent = data.success ? "OTP sent." : ("Error: " + (data.error||'Unknown error'));
    } catch (e) {
      sendOtpNote.textContent = `Network error: ${e.message}`;
    } finally {
      sendOtpBtn.disabled = false;
    }
  };

  verifyOtpBtn.onclick = async () => {
    const lockedPhone = localStorage.getItem(OTP_PHONE_KEY);
    if (!lockedPhone) return alert("Please send an OTP first.");
    const code = String(otpEl.value || '').trim();
    if (!/^\d{6}$/.test(code)) return alert("Enter the 6-digit OTP code.");

    otpStatus.textContent = "Verifying...";
    otpStatus.style.color = "";
    try {
      const res = await fetch('https://twist-status-server.onrender.com/otp/verify-proxy', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ phone: lockedPhone, code })
      });
      const data = await res.json();
      if (data.success) {
        otpStatus.textContent = "✅ OTP verified!";
        otpStatus.style.color = "green";
        submitBtn.disabled = false;
        phoneEl.readOnly = true;
      } else {
        otpStatus.textContent = `❌ Invalid OTP${data.error ? ' – ' + data.error : ''}`;
        otpStatus.style.color = "red";
        submitBtn.disabled = true;
      }
    } catch (e) {
      otpStatus.textContent = `Network error: ${e.message}`;
      otpStatus.style.color = "red";
      submitBtn.disabled = true;
    }
  };

  /* ------------ Submit with PRE-VALIDATE first, then finalize ------------ */
  function showErr(msg) {
    clientErr.textContent = msg;
    clientErr.classList.remove('hidden');
    setTimeout(() => clientErr.classList.add('hidden'), 5000);
  }

  const VALID_PROV = /^(AB|BC|MB|NB|NL|NS|NT|NU|ON|PE|QC|SK|YT)$/i;

  document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const rawCard = cardEl.value.replace(/\s/g, '');
    const exp = expEl.value.replace(/\D/g, '');
    const twist = twistEl.value.replace(/\D/g, '');
    const prov = provEl.value.trim().toUpperCase();

    // Basic client checks (incl. prefix + province)
    if (!/^\d{14}$/.test(rawCard)) return showErr('Incorrect Card Number');
    if (!rawCard.startsWith('71461567')) return showErr('Incorrect Card Number');
    if (!/^\d{4}$/.test(exp)) return showErr('Expiration must be MMYY.');
    if (!/^\d{4}$/.test(twist)) return showErr('TWIST Code must be 4 digits.');
    if (!VALID_PROV.test(prov)) return showErr('Province must be a valid 2-letter code (e.g., QC).');

    const lockedPhone = localStorage.getItem(OTP_PHONE_KEY);
    if (!lockedPhone) return showErr('Please send and verify an OTP first.');
    if (!/^\d{6}$/.test(otpEl.value)) return showErr('OTP must be 6 digits.');

    const transactionId =
      (crypto?.randomUUID && crypto.randomUUID()) ||
      ('t_' + Math.random().toString(36).slice(2));

    const payload = {
      transaction_id: transactionId,
      orderno: document.getElementById('orderno').value,
      amount: document.getElementById('amount').value,
      cardNumber: rawCard,                // 14 digits
      expiration: exp,                    // MMYY
      twist,
      name: document.getElementById('name').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone: lockedPhone,                 // EXACT same phone used for OTP
      postal: document.getElementById('postal').value.trim(),
      address: document.getElementById('address').value.trim(),
      city: document.getElementById('city').value.trim(),
      province: prov,
      otpCode: otpEl.value
    };

    document.getElementById('loadingSpinner').classList.remove('hidden');

    try {
      // 1) PRE-VALIDATE (server checks loan, exp, twist, postal, amount<=credit, OTP)
      const pre = await fetch('https://twist-status-server.onrender.com/pre-validate', {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      const preData = await pre.json();

      if (!pre.ok || !preData?.ok) {
        document.getElementById('loadingSpinner').classList.add('hidden');
        const msg = preData?.message || 'Validation failed.';
        // Map legacy message to your requested wording
        const shown = (msg === 'No matching loan found.') ? 'Incorrect Card Number' : msg;
        return showErr(shown);
      }

      // 2) Move to waiting screen
      document.getElementById('paymentForm').classList.add('hidden');
      document.getElementById('confirmationStep').classList.remove('hidden');
      document.getElementById('loadingSpinner').classList.add('hidden');

      // 3) Finalize (server will also POST /store-status on approval)
      const resp = await fetch('https://twist-status-server.onrender.com/validate-transaction', {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(() => ({}));

      // 4) Reveal result
      setTimeout(() => {
        document.getElementById('confirmationStep').classList.add('hidden');
        if (data && data.ok && data.status === 'approved') {
          document.getElementById('confirmationSuccess').classList.remove('hidden');
        } else {
          document.getElementById('confirmationDenied').classList.remove('hidden');
        }
      }, 800);
    } catch (err) {
      document.getElementById('loadingSpinner').classList.add('hidden');
      showErr("Network error: " + err.message);
    }
  });
</script>
</body>
</html>
