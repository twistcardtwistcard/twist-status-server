<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TWIST Card Payment</title>
<style>
  :root{
    --brand:#f97316; --brand-600:#ea580c; --brand-700:#c2410c;
    --muted:#6b7280; --ok:#16a34a; --bad:#dc2626; --border:#e5e7eb;
    --ring:rgba(249,115,22,.28);
    --btn-gray:#6b7280; --btn-gray-700:#4b5563;
    --purple:#7c3aed;
  }

  /* Page */
  body{
    margin:0; padding:1.5rem; background:#fff; color:#111827;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; text-rendering:optimizeLegibility;
  }

  .form-wrapper{ max-width:540px; margin:auto; padding-top:.25rem; }
  .form-wrapper h2{ font-weight:800; letter-spacing:-.02em; margin:0 0 .5rem; }

  #orderDetails{
    background:#fff; border:1px solid var(--border); border-radius:12px;
    padding:.75rem .9rem;
  }

  /* Card container */
  .form-container{
    background:#fff; border:1px solid var(--border); border-radius:16px;
    padding:1.25rem; box-shadow:none; position:relative; overflow:hidden;
  }

  /* Grid & inputs */
  .row{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:.9rem; }
  .row3{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:.9rem; }
  .form-group{ margin-bottom:1rem; min-width:0; }
  label{ font-weight:600; display:flex; align-items:center; gap:.4rem; margin-bottom:.35rem; font-size:.95rem; color:#374151; }
  input,button{ min-width:0; box-sizing:border-box; }
  input{
    width:100%; padding:.65rem .7rem; font-size:16px; line-height:1.25rem;
    border-radius:10px; border:1px solid #d1d5db; outline:none; background:#fff;
    transition:border-color .15s ease, box-shadow .15s ease, transform .06s ease;
  }
  input:hover{ border-color:#cbd5e1; }
  input:focus{ border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); transform:translateY(-1px); }
  input::placeholder{ color:#9ca3af; }

  /* Buttons */
  button{
    background:linear-gradient(180deg,var(--brand),var(--brand-600));
    color:#fff; border:none; border-radius:10px; font-size:15px; font-weight:800;
    padding:.8rem 1.1rem; cursor:pointer; transition:transform .08s ease, filter .12s ease;
  }
  button:hover{ transform:translateY(-1px); filter:brightness(1.02); }
  button:active{ transform:translateY(0); }

  /* OTP inline */
  .btn-inline{ display:flex; gap:.5rem; align-items:stretch; }
  .btn-inline input{ flex:1 1 auto; min-width:0; }
  .btn-inline button{ flex:0 0 auto; box-shadow:none !important; } /* no shadows on OTP buttons */

  /* Secondary (gray) buttons like SEND/RESEND OTP & VERIFY OTP */
  .btn-secondary{
    background:linear-gradient(180deg,var(--btn-gray),var(--btn-gray-700)) !important;
  }

  .muted{ color:var(--muted); font-size:.92rem; }
  .notice{
    border:1px solid #fde68a; background:#fffbeb; color:#854d0e;
    padding:.9rem; border-radius:8px; margin-bottom:1rem;
  }
  .hidden{ display:none !important; }
  .spinner{ width:44px; height:44px; border:4px solid #e5e7eb; border-top:4px solid var(--brand); border-radius:50%; animation:spin 1s linear infinite; margin:1rem auto; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .ok{ color:#059669; font-weight:700; }
  .bad{ color:#dc2626; font-weight:700; }
  .err{
    background:#fff1f2; border:1px solid #fecdd3; color:#be123c;
    padding:.6rem .75rem; border-radius:8px; margin-top:.5rem;
  }

  /* Field-level error */
  .err-inline{
    color:var(--bad); font-size:.86rem; margin-top:.35rem;
  }
  .input-error{
    border-color:var(--bad) !important;
    box-shadow:0 0 0 3px rgba(220,38,38,.15) !important;
  }

  /* Info icon (TWIST) */
  .info-btn{
    all:unset; display:inline-flex; align-items:center; justify-content:center;
    width:18px; height:18px; border-radius:50%; background:var(--purple); color:#fff;
    font-size:.8rem; line-height:1; cursor:pointer;
  }

  /* Dialog */
  .dialog-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:50;
  }
  .dialog{
    background:#fff; border:1px solid var(--border); border-radius:12px; padding:1rem; max-width:420px; width:92%;
  }

  /* Mobile */
  @media (max-width:640px){
    .row,.row3{ grid-template-columns:1fr; }
    .form-container{ padding:1rem; }
  }
  @media (prefers-reduced-motion:reduce){
    *{ transition:none !important; animation:none !important; }
  }
</style>
</head>
<body>
<div class="form-wrapper">
  <h2>Pay for your order with your TWIST CARD</h2>
  <p id="orderDetails" class="muted"></p>

  <div class="form-container" role="region" aria-label="Twist Card payment form">
    <div style="text-align:center; margin-bottom:1rem;">
      <img style="max-width:160px" alt="Twist Card"
           src="https://cdn.shopify.com/s/files/1/0745/9635/2225/files/Twist_500ppx.jpg?v=1748980607">
    </div>

    <div class="notice hidden" id="autoFillNotice">
      <strong>These fields should be auto filled.</strong><br>
      To pay with your card, click on the link provided in your order confirmation.
    </div>

    <!-- TWIST info dialog -->
    <div id="twistDialogWrap" class="dialog-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="twistDialogTitle">
      <div class="dialog">
        <h3 id="twistDialogTitle" style="margin:.2rem 0 .6rem; font-weight:800;">About your TWIST Code</h3>
        <p class="muted" style="margin:0 0 .9rem;">
          You will find your 4 digits code in the <strong>TWIST Code</strong> section of the APP.
        </p>
        <div style="text-align:right;">
          <button type="button" id="twistDialogOk">OK</button>
        </div>
      </div>
    </div>

    <form id="paymentForm" autocomplete="off" novalidate>
      <fieldset style="background:#fff; padding:1rem; border:1px solid var(--border); border-radius:10px; margin-bottom:1rem;">
        <div class="form-group">
          <label for="orderno">Order Number</label>
          <input type="text" id="orderno" readonly aria-readonly="true">
        </div>
        <div class="form-group">
          <label for="amount">Amount</label>
          <input type="text" id="amount" readonly aria-readonly="true">
        </div>
      </fieldset>

      <div class="form-group">
        <label for="cardNumber">Card Number</label>
        <input type="text" id="cardNumber" maxlength="17" inputmode="numeric" required placeholder="(14 digits)">
        <div id="cardNumber_err" class="err-inline hidden"></div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="expiration">Expiration (MMYY)</label>
          <input type="text" id="expiration" placeholder="MMYY" inputmode="numeric" required>
          <div id="expiration_err" class="err-inline hidden"></div>
        </div>
        <div class="form-group">
          <label for="twist">TWIST Code (XXXX) <button type="button" class="info-btn" id="twistInfoBtn" aria-label="What is TWIST code?">i</button></label>
          <input type="text" id="twist" maxlength="4" inputmode="numeric" required>
          <div id="twist_err" class="err-inline hidden"></div>
        </div>
      </div>

      <div class="form-group">
        <label for="postal">Postal Code</label>
        <input type="text" id="postal" autocomplete="postal-code" required>
        <div id="postal_err" class="err-inline hidden"></div>
      </div>

      <div class="form-group">
        <label for="name">Cardholder Name</label>
        <input type="text" id="name" required autocomplete="cc-name">
        <div id="name_err" class="err-inline hidden"></div>
      </div>

      <div class="form-group">
        <label for="email">Email (must match your account)</label>
        <input type="email" id="email" required autocomplete="email">
        <div id="email_err" class="err-inline hidden"></div>
      </div>

      <!-- OTP SECTION (hidden until "verify only" succeeds) -->
      <div id="otpSection" class="hidden">
        <div class="form-group">
          <label id="sendOtpLabel" class="muted">Send a code to phone ending with ••••</label>
          <div class="btn-inline">
            <button type="button" id="sendOtpBtn" class="btn-secondary">Send OTP</button>
            <div id="resendTimer" class="muted" style="align-self:center;"></div>
          </div>
          <div id="sendOtpNote" class="muted" style="margin-top:.35rem;"></div>
        </div>

        <div class="form-group">
          <label for="otpCode">Enter OTP</label>
          <div class="btn-inline">
            <input type="text" id="otpCode" inputmode="numeric" placeholder="6-digit code">
            <button type="button" id="verifyOtpBtn" class="btn-secondary">Verify OTP</button>
          </div>
          <div id="otpCode_err" class="err-inline hidden"></div>
          <div id="otpStatus" class="muted" style="margin-top:.5rem; font-weight:700;"></div>
        </div>
      </div>

      <div id="clientErr" class="err hidden"></div>

      <!-- Single primary action -->
      <div style="margin-top:.25rem;">
        <button type="submit" id="submitBtn">NEXT STEP</button>
      </div>

      <div id="loadingSpinner" class="hidden" style="text-align:center; margin-top: 1rem;">
        <div class="spinner" aria-hidden="true"></div>
        <p>Processing your payment...</p>
      </div>
    </form>

    <div id="confirmationStep" class="hidden" style="text-align:center;">
      <h3>STEP 2 — We are validating your information.</h3>
      <div class="spinner" aria-hidden="true"></div>
      <p>Please wait a moment for confirmation.</p>
    </div>

    <div id="confirmationSuccess" class="hidden" style="text-align:center;">
      <h2 class="ok">✅ Transaction Approved</h2>
      <p>Thank you! Your payment was successfully processed.</p>
    </div>

    <div id="confirmationDenied" class="hidden" style="text-align:center;">
      <h2 class="bad">❌ Transaction Denied</h2>
      <p>Please contact Twist Card customer service.</p>
    </div>
  </div>
</div>

<script>
  /* ------------ URL params + FALLBACKS ------------ */
  const LS_KEYS = {
    orderno: 'twistpay:lastOrderno',
    amount:  'twistpay:lastAmount',
    email:   'twistpay:lastEmail',
  };
  const OTP_PHONE_KEY = 'twistpay:lastOtpPhone';
  const OTP_CODE_KEY  = 'twistpay:lastOtpCode';
  const OTP_VF_TS_KEY = 'twistpay:otpVerifiedTs';
  const OTP_ATTEMPTS_PREFIX = 'twistpay:otpAttempts:'; // + last10

  const OTP_TTL_MS = 10 * 60 * 1000;  // 10 minutes
  const RESEND_SECONDS = 45;
  const MAX_VERIFY_ATTEMPTS = 5;

  /* ------------ Field-error helpers ------------ */
  const FIELD_IDS = ['cardNumber','expiration','twist','postal','name','email','otpCode'];
  function setFieldError(id, msg){
    const input = document.getElementById(id);
    const err = document.getElementById(id + '_err');
    if (!input || !err) return;
    if (msg){
      err.textContent = msg;
      err.classList.remove('hidden');
      input.classList.add('input-error');
      input.setAttribute('aria-invalid','true');
    } else {
      err.textContent = '';
      err.classList.add('hidden');
      input.classList.remove('input-error');
      input.removeAttribute('aria-invalid');
    }
  }
  function clearAllFieldErrors(){ FIELD_IDS.forEach(id => setFieldError(id, '')); }

  function mapServerMessageToField(msg){
    const m = String(msg||'').toLowerCase();
    if (m.includes('card')) return 'cardNumber';
    if (m.startsWith('expiration') || m.includes('mm/yy') || m.includes('mmyy')) return 'expiration';
    if (m.includes('twist')) return 'twist';
    if (m.includes('postal')) return 'postal';
    if (m.includes('email')) return 'email';
    if (m.includes('otp')) return 'otpCode';
    return null;
  }

  function showGlobalErr(msg){
    const clientErr = document.getElementById('clientErr');
    clientErr.textContent = msg;
    clientErr.classList.remove('hidden');
    setTimeout(() => clientErr.classList.add('hidden'), 5000);
  }

  function scrollToTop(){
    try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch { window.scrollTo(0,0); }
  }

  function setField(id, val) {
    if (typeof val !== 'string' || !val.length) return;
    const el = document.getElementById(id);
    if (el) el.value = val;
  }
  function parseParams(url) {
    try { return new URL(url).searchParams; } catch { return new URLSearchParams(''); }
  }
  function pickFrom(sp) {
    return {
      amount:  sp.get('t_amount')  || sp.get('amount')  || '',
      orderno: sp.get('t_orderno') || sp.get('orderno') || '',
      email:   sp.get('t_email')   || sp.get('email')   || ''
    };
  }
  (function initPrefill() {
    const isFramed = (window.top !== window.self);
    const childQP = new URLSearchParams(window.location.search);
    let vals = pickFrom(childQP);
    if (isFramed && (!vals.amount || !vals.orderno || !vals.email)) {
      const parentQP = parseParams(document.referrer || '');
      const fromParent = pickFrom(parentQP);
      vals = {
        amount:  vals.amount  || fromParent.amount,
        orderno: vals.orderno || fromParent.orderno,
        email:   vals.email   || fromParent.email
      };
    }
    if (!vals.amount)  vals.amount  = localStorage.getItem(LS_KEYS.amount)  || '';
    if (!vals.orderno) vals.orderno = localStorage.getItem(LS_KEYS.orderno) || '';
    if (!vals.email)   vals.email   = localStorage.getItem(LS_KEYS.email)   || '';

    setField('amount',  vals.amount);
    setField('orderno', vals.orderno);
    setField('email',   vals.email);

    if (!vals.orderno || !vals.amount) document.getElementById('autoFillNotice').classList.remove('hidden');

    document.getElementById('orderDetails').innerHTML =
      `Order Number: <strong>${vals.orderno || '-'}</strong><br>Total: <strong>$${vals.amount || '-'}</strong>`;
  })();

  function persistBasics({ amount, orderno, email }) {
    if (amount)  localStorage.setItem(LS_KEYS.amount, amount);
    if (orderno) localStorage.setItem(LS_KEYS.orderno, orderno);
    if (email)   localStorage.setItem(LS_KEYS.email, email);
  }

  /* ------------ Helpers ------------ */
  const last4 = (p) => (String(p||'').replace(/\D/g,'').slice(-4));
  function isVerifiedFresh(){
    const ts = Number(localStorage.getItem(OTP_VF_TS_KEY) || 0);
    return !!ts && (Date.now() - ts) < OTP_TTL_MS;
  }
  function markVerified(phone, code){
    localStorage.setItem(OTP_PHONE_KEY, phone);
    localStorage.setItem(OTP_CODE_KEY, String(code||''));
    localStorage.setItem(OTP_VF_TS_KEY, String(Date.now()));
    updateSubmitLabel();
  }

  /* ------------ Inputs / elements ------------ */
  const cardEl = document.getElementById('cardNumber');
  const expEl = document.getElementById('expiration');
  const twistEl = document.getElementById('twist');
  const postalEl = document.getElementById('postal');
  const nameEl = document.getElementById('name');
  const emailEl = document.getElementById('email');

  const otpSection = document.getElementById('otpSection');
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const sendOtpLabel = document.getElementById('sendOtpLabel');
  const resendTimerEl = document.getElementById('resendTimer');
  const sendOtpNote = document.getElementById('sendOtpNote');
  const otpEl = document.getElementById('otpCode');
  const otpStatus = document.getElementById('otpStatus');
  const submitBtn = document.getElementById('submitBtn');

  let canSubmitPayment = false; // phase flag

  function updateSubmitLabel(){
    const havePhone = !!localStorage.getItem(OTP_PHONE_KEY);
    const haveFresh = isVerifiedFresh() && /^\d{6}$/.test(localStorage.getItem(OTP_CODE_KEY) || '');
    canSubmitPayment = canSubmitPayment || (havePhone && haveFresh);
    submitBtn.textContent = canSubmitPayment ? 'Submit Payment' : 'NEXT STEP';
  }
  updateSubmitLabel();

  /* ------------ masks & on-type clear error ------------ */
  function clearOnInput(el, fieldId){
    el.addEventListener('input', () => setFieldError(fieldId, ''));
  }
  clearOnInput(cardEl,'cardNumber');
  clearOnInput(expEl,'expiration');
  clearOnInput(twistEl,'twist');
  clearOnInput(postalEl,'postal');
  clearOnInput(nameEl,'name');
  clearOnInput(emailEl,'email');

  cardEl.addEventListener('input', function () {
    let v = this.value.replace(/\D/g, '');
    if (v.length > 14) v = v.slice(0, 14);
    this.value = v.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
  });
  expEl.addEventListener('input', function () {
    let v = this.value.replace(/\D/g, '');
    this.value = v.slice(0, 4);
  });
  twistEl.addEventListener('input', function () {
    this.value = this.value.replace(/\D/g, '').slice(0, 4);
  });

  otpEl.addEventListener('input', () => {
    otpEl.value = otpEl.value.replace(/\D/g, '').slice(0, 6);
    setFieldError('otpCode','');
  });

  /* ------------ TWIST info dialog ------------ */
  const infoBtn = document.getElementById('twistInfoBtn');
  const dlgWrap = document.getElementById('twistDialogWrap');
  const dlgOk = document.getElementById('twistDialogOk');
  infoBtn.addEventListener('click', ()=> dlgWrap.classList.remove('hidden'));
  dlgOk.addEventListener('click', ()=> dlgWrap.classList.add('hidden'));

  /* ------------ OTP cooldown + attempts + persistence ------------ */
  let cooldownTimer = null;
  function startCooldown(seconds=RESEND_SECONDS){
    if (cooldownTimer) { clearInterval(cooldownTimer); cooldownTimer = null; }
    let remain = seconds;
    sendOtpBtn.disabled = true;
    resendTimerEl.textContent = `Resend available in ${remain}s`;
    cooldownTimer = setInterval(()=>{
      remain--;
      if (remain <= 0) {
        clearInterval(cooldownTimer);
        cooldownTimer = null;
        resendTimerEl.textContent = '';
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Resend OTP';
      } else {
        resendTimerEl.textContent = `Resend available in ${remain}s`;
      }
    }, 1000);
  }
  function attemptsKeyForPhone(phone){
    const l10 = String(phone||'').replace(/\D/g,'').slice(-10);
    return OTP_ATTEMPTS_PREFIX + l10;
  }
  function getAttempts(phone){
    const k = attemptsKeyForPhone(phone);
    return Number(localStorage.getItem(k) || 0);
  }
  function incAttempts(phone){
    const k = attemptsKeyForPhone(phone);
    const v = getAttempts(phone) + 1;
    localStorage.setItem(k, String(v));
    return v;
  }
  function resetAttempts(phone){
    const k = attemptsKeyForPhone(phone);
    localStorage.removeItem(k);
  }

  async function derivePhone(card, exp, twist, postal){
    const res = await fetch('/otp/derive-phone', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ cardNumber: card, expiration: exp, twist, postal })
    });
    const data = await res.json().catch(() => null);
    if (!res.ok || !data?.success) {
      // Force a clear, field-specific message by defaulting to expiration per your request.
      const serverMsg = data && data.message ? String(data.message) : '';
      // Try mapping known messages first
      const fld = mapServerMessageToField(serverMsg);
      if (fld) throw new Error(serverMsg);
      // Otherwise default to expiration-friendly copy
      throw new Error('Expiration not valid.');
    }
    return data.phone;
  }

  async function sendOtp(phone){
    sendOtpBtn.disabled = true;
    sendOtpBtn.textContent = 'Sending...';
    sendOtpNote.textContent = 'Sending...';
    try{
      const res = await fetch('https://twilio-otp-server.onrender.com/send-otp', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ phone })
      });
      const data = await res.json();
      if (data.success) {
        sendOtpNote.textContent = `Code sent to phone ending with ${last4(phone)}.`;
        startCooldown();
      } else {
        sendOtpNote.textContent = 'Error sending OTP: ' + (data.error || 'Unknown error');
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Send OTP';
      }
    }catch(e){
      sendOtpNote.textContent = 'Network error: ' + e.message;
      sendOtpBtn.disabled = false;
      sendOtpBtn.textContent = 'Send OTP';
    }
  }

  /* ------------ VERIFY OTP button ------------ */
  verifyOtpBtn.onclick = async () => {
    const phone = localStorage.getItem(OTP_PHONE_KEY);
    if (!phone) return setFieldError('otpCode','Please press NEXT STEP first.');
    const code = String(otpEl.value || '').trim();
    if (!/^\d{6}$/.test(code)) return setFieldError('otpCode','OTP must be 6 digits.');

    const attempts = incAttempts(phone);
    if (attempts > MAX_VERIFY_ATTEMPTS) {
      setFieldError('otpCode','Too many attempts. Please try again later.');
      otpStatus.textContent = '❌ Too many attempts.';
      otpStatus.style.color = 'red';
      verifyOtpBtn.disabled = true;
      return;
    }

    otpStatus.textContent = 'Verifying...';
    otpStatus.style.color = '';
    try{
      const res = await fetch('/otp/verify-proxy', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ phone, code })
      });
      const data = await res.json();
      if (data.success) {
        otpStatus.textContent = '✅ OTP verified!';
        otpStatus.style.color = 'green';
        setFieldError('otpCode','');
        markVerified(phone, code);
        resetAttempts(phone);
      } else {
        setFieldError('otpCode','Invalid OTP.');
        otpStatus.textContent = '❌ Invalid OTP' + (data.message ? ' – ' + data.message : '');
        otpStatus.style.color = 'red';
      }
    }catch(e){
      setFieldError('otpCode','Network error verifying OTP.');
      otpStatus.textContent = 'Network error: ' + e.message;
      otpStatus.style.color = 'red';
    }
  };

  /* ------------ Client checks (field-level) ----------- */
  function clientBasicsValid(rawCard, exp, twist, postal){
    let ok = true;
    clearAllFieldErrors();

    if (!/^\d{14}$/.test(rawCard) || !rawCard.startsWith('71461567')) {
      setFieldError('cardNumber','Incorrect Card Number');
      ok = false;
    }
    if (!/^\d{4}$/.test(exp)) {
      setFieldError('expiration','Expiration must be MMYY.');
      ok = false;
    }
    if (!/^\d{4}$/.test(twist)) {
      setFieldError('twist','TWIST Code must be 4 digits.');
      ok = false;
    }
    if (!postal) {
      setFieldError('postal','Postal code required.');
      ok = false;
    }
    if (!document.getElementById('name').value.trim()){
      setFieldError('name','Cardholder name is required.');
      ok = false;
    }
    const emailVal = document.getElementById('email').value.trim();
    if (!emailVal){
      setFieldError('email','Email is required.');
      ok = false;
    }
    return ok;
  }

  /* ------------ Primary SUBMIT: two phases ------------ */
  document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const rawCard = cardEl.value.replace(/\s/g, '');
    const exp = expEl.value.replace(/\D/g, '');
    const twist = twistEl.value.replace(/\D/g, '');
    const postal = postalEl.value.trim().toUpperCase().replace(/\s/g,'');

    if (!clientBasicsValid(rawCard, exp, twist, postal)) return;

    if (!canSubmitPayment) {
      // PHASE 1: verify-only (no OTP sent here)
      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying...';
      try{
        const phone = await derivePhone(rawCard, exp, twist, postal);
        // Success → reveal OTP UI, do NOT send automatically
        localStorage.setItem(OTP_PHONE_KEY, phone);
        sendOtpLabel.textContent = `Send a code to phone ending with ${last4(phone)}`;
        otpSection.classList.remove('hidden');
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Send OTP';
        sendOtpNote.textContent = '';
        otpStatus.textContent = '';

        // If a fresh verified OTP exists, keep it and allow direct submit
        if (isVerifiedFresh() && /^\d{6}$/.test(localStorage.getItem(OTP_CODE_KEY) || '')) {
          const prevCode = localStorage.getItem(OTP_CODE_KEY);
          otpEl.value = prevCode;
          otpStatus.textContent = '✅ OTP previously verified (still valid).';
          otpStatus.style.color = 'green';
        } else {
          otpEl.value = '';
        }

        canSubmitPayment = true;
        updateSubmitLabel(); // → Submit Payment
      }catch(err){
        // Always show field-specific error. Map known messages; default to Expiration.
        const msg = String(err && err.message || '');
        const fld = mapServerMessageToField(msg) || 'expiration';
        const friendly = fld === 'expiration' && (!msg || /unable to/i.test(msg))
          ? 'Expiration not valid.'
          : (msg || 'Expiration not valid.');
        setFieldError(fld, friendly);

        // Clear stale phone and reset UI
        localStorage.removeItem(OTP_PHONE_KEY);
        otpSection.classList.add('hidden');
        canSubmitPayment = false;
        submitBtn.textContent = 'NEXT STEP';
      }finally{
        submitBtn.disabled = false;
      }
      return;
    }

    // PHASE 2: submit payment (requires OTP)
    const phone = localStorage.getItem(OTP_PHONE_KEY);
    const otpCode = String(otpEl.value || localStorage.getItem(OTP_CODE_KEY) || '').trim();
    if (!phone) {
      showGlobalErr('Please verify your details first.');
      canSubmitPayment = false;
      updateSubmitLabel();
      return;
    }
    if (!/^\d{6}$/.test(otpCode)) {
      setFieldError('otpCode','OTP must be 6 digits.');
      return;
    }

    await proceedPayment({ rawCard, exp, twist, postal, phone, otpCode });
  });

  async function proceedPayment({ rawCard, exp, twist, postal, phone, otpCode }){
    const transactionId =
      (crypto?.randomUUID && crypto.randomUUID()) ||
      ('t_' + Math.random().toString(36).slice(2));

    const payload = {
      transaction_id: transactionId,
      orderno: document.getElementById('orderno').value,
      amount: document.getElementById('amount').value,
      cardNumber: rawCard,
      expiration: exp,
      twist,
      name: document.getElementById('name').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone,
      postal,
      address: '', city: '', province: '',
      otpCode
    };

    persistBasics({ amount: payload.amount, orderno: payload.orderno, email: payload.email });
    document.getElementById('loadingSpinner').classList.remove('hidden');
    scrollToTop(); // ensure spinner is visible

    try {
      // PRE-VALIDATE (server checks & OTP confirm)
      const pre = await fetch('/pre-validate', {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      const preData = await pre.json();

      if (!pre.ok || !preData?.ok) {
        document.getElementById('loadingSpinner').classList.add('hidden');
        const msg = preData?.message || 'Validation failed.';
        const f = mapServerMessageToField(msg);
        if (f) setFieldError(f, msg);
        else showGlobalErr((msg === 'No matching loan found.') ? 'Incorrect Card Number' : msg);
        return;
      }

      // Waiting screen
      document.getElementById('paymentForm').classList.add('hidden');
      document.getElementById('confirmationStep').classList.remove('hidden');
      document.getElementById('loadingSpinner').classList.add('hidden');
      scrollToTop(); // ensure confirmation step is visible

      // Finalize
      const resp = await fetch('/validate-transaction', {
        method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(() => ({}));

      // Show result after 3s spinner
      setTimeout(() => {
        document.getElementById('confirmationStep').classList.add('hidden');
        if (data && data.ok && data.status === 'approved') {
          document.getElementById('confirmationSuccess').classList.remove('hidden');
        } else {
          document.getElementById('confirmationDenied').classList.remove('hidden');
        }
        scrollToTop();
      }, 3000);
    } catch (err) {
      document.getElementById('loadingSpinner').classList.add('hidden');
      showGlobalErr("Network error: " + err.message);
    }
  }

  /* ------------ Send OTP button ------------ */
  sendOtpBtn.onclick = async () => {
    const phone = localStorage.getItem(OTP_PHONE_KEY);
    if (!phone) return showGlobalErr('Please click NEXT STEP first.');
    await sendOtp(phone);
  };

  /* ------------ Stable auto-height for iframes (content-only, no drift) ------------ */
  (function () {
    let lastSent = 0;
    let ticking = false;

    function contentHeight() {
      const b = document.body, d = document.documentElement;
      // Strict content height only; avoids viewport feedback loops
      return Math.max(b.scrollHeight, d.scrollHeight);
    }

    function postHeight(force) {
      const h = Math.ceil(contentHeight());
      if (!force && Math.abs(h - lastSent) < 4) return; // ignore tiny changes
      lastSent = h;
      try { parent.postMessage({ type: "twistpay:height", value: h }, "*"); } catch (e) {}
    }

    // Debounced on layout changes
    const ro = new ResizeObserver(() => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => { ticking = false; postHeight(false); });
    });
    ro.observe(document.body);

    const mo = new MutationObserver(() => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => { ticking = false; postHeight(false); });
    });
    mo.observe(document.body, { childList: true, subtree: true, attributes: true, characterData: true });

    // Initial + a small delayed kick (fonts/images)
    window.addEventListener("load", () => postHeight(true));
    setTimeout(() => postHeight(true), 300);
  })();
</script>
</body>
</html>
